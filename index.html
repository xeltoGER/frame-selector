<!DOCTYPE html>
<html lang="de" class="bg-black text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame Selector | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #000; }
        /* Trick für Android: Video muss "sichtbar" sein zum Dekodieren */
        .android-video-fix {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            opacity: 0.01;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const formatTime = (seconds) => {
            if (!seconds) return "00:00.000";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
        };

        const App = () => {
            const [videoUrl, setVideoUrl] = useState(null);
            const [duration, setDuration] = useState(0);
            const [startFrame, setStartFrame] = useState(null);
            const [endFrame, setEndFrame] = useState(null);
            const [manualFrame, setManualFrame] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            
            const videoRef = useRef(null);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    setVideoUrl(url);
                }
            };

            const capture = async (time) => {
                const v = videoRef.current;
                return new Promise((resolve) => {
                    const onSeeked = () => {
                        v.removeEventListener('seeked', onSeeked);
                        // Android Hardware-Buffer Delay
                        setTimeout(() => {
                            const canvas = document.createElement('canvas');
                            canvas.width = v.videoWidth;
                            canvas.height = v.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.9));
                        }, 250); 
                    };
                    v.addEventListener('seeked', onSeeked);
                    v.currentTime = time;
                });
            };

            const processAuto = async () => {
                setIsProcessing(true);
                const start = await capture(0.1); // 0.1s statt 0 wegen mancher Codecs
                setStartFrame(start);
                const end = await capture(duration - 0.1);
                setEndFrame(end);
                setIsProcessing(false);
            };

            const download = (data, name) => {
                const a = document.createElement('a');
                a.href = data;
                a.download = `frame-${name}.jpg`;
                a.click();
            };

            return (
                <div className="p-8 max-w-4xl mx-auto">
                    <h1 className="text-4xl font-black mb-8 tracking-tighter uppercase italic">Frame Selector</h1>
                    
                    {!videoUrl ? (
                        <div className="border-2 border-dashed border-neutral-800 p-20 text-center">
                            <input type="file" accept="video/*" onChange={handleFileUpload} className="hidden" id="v-up" />
                            <label htmlFor="v-up" className="bg-white text-black px-6 py-3 cursor-pointer font-bold uppercase">Video wählen</label>
                        </div>
                    ) : (
                        <div className="space-y-8">
                            {/* Der Android-Fix-Player */}
                            <video 
                                ref={videoRef} 
                                src={videoUrl} 
                                className="android-video-fix"
                                muted playsInline crossOrigin="anonymous"
                                onLoadedMetadata={(e) => setDuration(e.currentTarget.duration)}
                            />

                            <button onClick={processAuto} disabled={isProcessing} className="w-full bg-blue-600 p-4 font-bold uppercase">
                                {isProcessing ? "Verarbeite..." : "Start/Ende automatisch extrahieren"}
                            </button>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <p className="text-xs uppercase mb-2 text-neutral-500">Start (00:00)</p>
                                    <div className="aspect-video bg-neutral-900 border border-neutral-800">
                                        {startFrame && <img src={startFrame} className="w-full h-full object-contain" onClick={() => download(startFrame, 'start')} />}
                                    </div>
                                </div>
                                <div>
                                    <p className="text-xs uppercase mb-2 text-neutral-500">Ende ({formatTime(duration)})</p>
                                    <div className="aspect-video bg-neutral-900 border border-neutral-800">
                                        {endFrame && <img src={endFrame} className="w-full h-full object-contain" onClick={() => download(endFrame, 'end')} />}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

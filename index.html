<!DOCTYPE html>
<html lang="de" class="bg-black text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame Selector | Grok Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #000; overflow-x: hidden; }
        .android-video-fix { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; }
        input[type=range] { -webkit-appearance: none; background: #262626; height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; background: #fff; cursor: pointer; border: 2px solid #3b82f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const formatTime = (seconds) => {
            if (!seconds) return "00:00.000";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
        };

        const App = () => {
            const [videoUrl, setVideoUrl] = useState(null);
            const [duration, setDuration] = useState(0);
            const [frames, setFrames] = useState({ start: null, end: null, manual: null });
            const [isProcessing, setIsProcessing] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [manualTime, setManualTime] = useState(0);
            
            const videoRef = useRef(null);
            const modalVideoRef = useRef(null);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    setVideoUrl(url);
                    setFrames({ start: null, end: null, manual: null });
                }
            };

            const capture = async (v) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    canvas.width = v.videoWidth;
                    canvas.height = v.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
                    // PNG für maximale Qualität (Grok-optimiert)
                    resolve(canvas.toDataURL('image/png'));
                });
            };

            const seekAndCapture = async (time) => {
                const v = videoRef.current;
                return new Promise((resolve) => {
                    const onSeeked = () => {
                        v.removeEventListener('seeked', onSeeked);
                        setTimeout(async () => {
                            resolve(await capture(v));
                        }, 300);
                    };
                    v.addEventListener('seeked', onSeeked);
                    v.currentTime = time;
                });
            };

            const processAuto = async () => {
                setIsProcessing(true);
                const s = await seekAndCapture(0.1);
                const e = await seekAndCapture(duration - 0.1);
                setFrames(prev => ({ ...prev, start: s, end: e }));
                setIsProcessing(false);
            };

            const download = (data, name) => {
                const a = document.createElement('a');
                a.href = data;
                a.download = `grok-frame-${name}-${Date.now()}.png`;
                a.click();
            };

            return (
                <div className="p-4 md:p-8 max-w-4xl mx-auto">
                    <header className="flex justify-between items-center mb-12">
                        <h1 className="text-3xl font-black tracking-tighter uppercase italic italic">Frame Selector <span className="text-blue-500 text-sm not-italic ml-2">PNG HQ</span></h1>
                        {videoUrl && <button onClick={() => window.location.reload()} className="text-xs text-neutral-500 hover:text-white uppercase">Reset</button>}
                    </header>
                    
                    {!videoUrl ? (
                        <div className="border-2 border-dashed border-neutral-800 rounded-xl p-16 text-center hover:border-blue-500/50 transition-colors">
                            <input type="file" accept="video/*" onChange={handleFileUpload} className="hidden" id="v-up" />
                            <label htmlFor="v-up" className="bg-white text-black px-10 py-5 cursor-pointer font-bold uppercase hover:scale-105 inline-block transition-transform">Video laden</label>
                            <p className="mt-4 text-neutral-600 text-sm uppercase tracking-widest">Bereit für PNG Extraktion</p>
                        </div>
                    ) : (
                        <div className="space-y-8">
                            <video ref={videoRef} src={videoUrl} className="android-video-fix" muted playsInline crossOrigin="anonymous" onLoadedMetadata={(e) => setDuration(e.currentTarget.duration)} />

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onClick={processAuto} disabled={isProcessing} className="bg-blue-600 hover:bg-blue-500 p-5 font-bold uppercase transition-all flex items-center justify-center gap-2">
                                    {isProcessing ? "Verarbeite..." : "Auto-Extrakt (Start/Ende)"}
                                </button>
                                <button onClick={() => setIsModalOpen(true)} className="border-2 border-white/20 hover:border-white p-5 font-bold uppercase transition-all">
                                    Frame manuell wählen
                                </button>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
                                {[
                                    { f: frames.start, l: 'Startframe', n: 'start' },
                                    { f: frames.end, l: 'Endframe', n: 'end' },
                                    { f: frames.manual, l: 'Manual Frame', n: 'manual' }
                                ].map((item, i) => item.f && (
                                    <div key={i} className="space-y-3 animate-in fade-in duration-500">
                                        <p className="text-[10px] uppercase text-blue-400 font-bold tracking-widest">{item.l}</p>
                                        <div className="aspect-video bg-neutral-900 border border-neutral-800 rounded-lg overflow-hidden group relative cursor-pointer" onClick={() => download(item.f, item.n)}>
                                            <img src={item.f} className="w-full h-full object-contain" />
                                            <div className="absolute inset-0 bg-blue-600/80 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                                                <span className="font-bold uppercase text-sm">Download PNG</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/fb z-50 flex flex-col p-4 backdrop-blur-xl">
                            <div className="flex justify-between items-center mb-6">
                                <span className="font-mono text-xl bg-neutral-900 px-4 py-2 rounded border border-neutral-800">{formatTime(manualTime)}</span>
                                <button onClick={() => setIsModalOpen(false)} className="bg-red-500/10 text-red-500 px-6 py-2 rounded-full font-bold uppercase hover:bg-red-500 hover:text-white transition-all">Schließen</button>
                            </div>
                            <div className="flex-1 flex items-center justify-center bg-neutral-950 rounded-2xl border border-neutral-900 overflow-hidden shadow-2xl">
                                <video ref={modalVideoRef} src={videoUrl} className="max-h-full max-w-full" muted playsInline crossOrigin="anonymous" onTimeUpdate={(e) => setManualTime(e.currentTarget.currentTime)} />
                            </div>
                            <div className="py-10 px-4 max-w-2xl mx-auto w-full space-y-8">
                                <input type="range" min="0" max={duration} step="0.001" value={manualTime} onChange={(e) => {
                                    const t = parseFloat(e.target.value);
                                    setManualTime(t);
                                    modalVideoRef.current.currentTime = t;
                                }} className="w-full cursor-pointer" />
                                <button onClick={async () => {
                                    const data = await capture(modalVideoRef.current);
                                    setFrames(prev => ({ ...prev, manual: data }));
                                    setIsModalOpen(false);
                                }} className="w-full bg-white text-black py-5 rounded-xl font-black uppercase text-lg hover:bg-blue-500 hover:text-white transition-all">Frame erfassen</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
